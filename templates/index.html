<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ‚æ¥µéš±å¯«è¡“å·¥å…·ç®±</title>
    <style>
        :root { --primary: #4a90e2; --success: #2ecc71; --danger: #e74c3c; --warn: #f39c12; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; min-height: 100vh; box-sizing: border-box; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* ä½å…ƒé¸æ“‡å€ */
        .controls-wrapper { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .control-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .reset-btn { background: #e0e0e0; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .reset-btn:hover { background: #d0d0d0; }
        
        .bit-grid { display: grid; grid-template-columns: 40px repeat(3, 1fr); gap: 6px; text-align: center; }
        .grid-header { font-weight: bold; padding: 6px; border-radius: 4px; font-size: 0.9rem; }
        .grid-row-label { font-weight: bold; line-height: 28px; color: #777; font-size: 0.9rem; }
        .bit-check { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { flex: 1; padding: 12px; cursor: pointer; text-align: center; font-weight: bold; color: #aaa; transition: 0.3s; border-bottom: 3px solid transparent; }
        .tab:hover { background: #f9f9f9; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab.analyze-tab.active { color: var(--warn); border-bottom: 3px solid var(--warn); }

        /* Panels */
        .panel { display: none; animation: fadeIn 0.3s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* UI Elements */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="file"], textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; }
        textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; color: white; transition: 0.2s; margin-top: 10px; }
        .btn-blue { background: var(--primary); } .btn-blue:hover { background: #357abd; }
        .btn-green { background: var(--success); } .btn-green:hover { background: #27ae60; }
        .btn-purple { background: #9b59b6; } .btn-purple:hover { background: #8e44ad; }
        
        .status-msg { margin-top: 10px; text-align: center; font-size: 0.95rem; font-weight: 500; min-height: 20px; }
        
        /* è§£ç¢¼çµæœèˆ‡åµæ¸¬ */
        #result-area { margin-top: 15px; display: none; }
        .result-box { background: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); word-break: break-all; white-space: pre-wrap; }
        
        /* åµæ¸¬ Canvas */
        .canvas-container { margin: 15px 0; border: 2px dashed #ccc; background: #222; min-height: 200px; display: flex; align-items: center; justify-content: center; padding: 10px; border-radius: 8px; }
        canvas { max-width: 100%; max-height: 400px; }
        
        .bit-buttons-grid { display: grid; grid-template-columns: 30px 1fr; gap: 10px; margin-top: 15px; }
        .btn-group { display: flex; gap: 5px; flex-wrap: wrap; }
        .bit-btn { flex: 1; padding: 6px 0; font-size: 0.8rem; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 4px; min-width: 30px; }
        .bit-btn:hover { background: #eee; }
        .bit-btn.active { background: #333; color: white; border-color: black; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ•µï¸â€â™‚ï¸ çµ‚æ¥µéš±å¯«è¡“å·¥å…·ç®±</h1>
    
    <div class="controls-wrapper">
        <div class="control-header">
            <strong>ğŸ”‘ ä½å…ƒåœ°åœ– (Bit Map) - åŠ è§£å¯†çš„é‘°åŒ™</strong>
            <button class="reset-btn" onclick="resetToDefault()">â†º é‡è¨­ç‚ºé è¨­ (LSB)</button>
        </div>
        <div class="bit-grid" id="bitGrid">
            <div></div>
            <div class="grid-header" style="background:#ffebee; color:#c62828">R</div>
            <div class="grid-header" style="background:#e8f5e9; color:#2e7d32">G</div>
            <div class="grid-header" style="background:#e3f2fd; color:#1565c0">B</div>
        </div>
        <p style="font-size: 0.8rem; color: #888; text-align: center; margin-top: 8px;">
            æç¤ºï¼šBit 0 å°ç•«è³ªå½±éŸ¿æœ€å°ï¼ŒBit 7 å½±éŸ¿æœ€å¤§ã€‚è§£å¯†æ™‚å¿…é ˆèˆ‡åŠ å¯†è¨­å®šå®Œå…¨ä¸€è‡´ã€‚
        </p>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="setMode('encode')">åŠ å¯† (Encode)</div>
        <div class="tab" onclick="setMode('decode')">è§£å¯† (Decode)</div>
        <div class="tab analyze-tab" onclick="setMode('analyze')">ğŸ‘ï¸ åµæ¸¬ (Analyze)</div>
        <div class="tab" style="color: #e67e22;" onclick="setMode('dct')">ğŸŒŠ æµ®æ°´å° (DCT)</div>
    </div>

    <div id="encode-panel" class="panel active">
        <div class="form-group">
            <label>1. ä¸Šå‚³åŸå§‹åœ–ç‰‡</label>
            <input type="file" id="enc-file" accept="image/*">
        </div>
        <div class="form-group">
            <label>2. è¼¸å…¥ç§˜å¯†è¨Šæ¯</label>
            <textarea id="enc-msg" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—..."></textarea>
        </div>
        <button class="btn btn-blue" onclick="process('encode')">ğŸ”’ å¯«å…¥éš±è—è¨Šæ¯ä¸¦ä¸‹è¼‰</button>
        <div id="enc-status" class="status-msg"></div>
    </div>

    <div id="decode-panel" class="panel">
        <div class="form-group">
            <label>ä¸Šå‚³å«æœ‰ç§˜å¯†çš„åœ–ç‰‡</label>
            <input type="file" id="dec-file" accept="image/*">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-green" onclick="process('decode')">ğŸ”“ ä¾è¨­å®šè§£å¯†</button>
            <button class="btn btn-purple" onclick="autoDecode()">ğŸª„ è‡ªå‹•æš´åŠ›ç ´è§£</button>
        </div>
        
        <div id="result-area">
            <div class="result-box">
                <strong id="res-title">è§£æçµæœï¼š</strong>
                <div id="dec-result-text" style="margin-top:5px;"></div>
            </div>
        </div>
        <div id="dec-status" class="status-msg"></div>
    </div>

    <div id="analyze-panel" class="panel">
        <div class="form-group">
            <label>ä¸Šå‚³è¦æª¢æŸ¥çš„åœ–ç‰‡</label>
            <input type="file" id="ana-file" accept="image/*">
        </div>
        <div class="canvas-container">
            <canvas id="ana-canvas"></canvas>
        </div>
        <p style="text-align: center; color: #666; font-size: 0.9rem;" id="ana-hint">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•åˆ‡æ›ä¸åŒä½å…ƒå±¤</p>
        
        <div class="bit-buttons-grid">
            <div style="color:#e74c3c; font-weight:bold; line-height:30px;">R</div>
            <div id="btn-group-0" class="btn-group"></div>
            <div style="color:#2ecc71; font-weight:bold; line-height:30px;">G</div>
            <div id="btn-group-1" class="btn-group"></div>
            <div style="color:#3498db; font-weight:bold; line-height:30px;">B</div>
            <div id="btn-group-2" class="btn-group"></div>
        </div>
    </div>

    <div id="dct-panel" class="panel">
        <div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffcc80;">
            <strong>ğŸŒŠ ä»€éº¼æ˜¯ DCT æµ®æ°´å°ï¼Ÿ</strong><br>
            ä¸åŒæ–¼ä¸Šé¢çš„ LSB åŠ å¯†ï¼ŒDCT æŠ€è¡“æ˜¯å°‡æ–‡å­—åˆ»åœ¨åœ–ç‰‡çš„ã€Œé »ç‡ã€ä¸­ã€‚<br>
            <span style="color: #d35400; font-size: 0.9em;">ç‰¹é»ï¼šæŠ—å£“ç¸® (å­˜æˆ JPG ä¹Ÿä¸æœƒæ¶ˆå¤±)ã€æŠ—è£åˆ‡ï¼Œä½†èƒ½è—çš„å­—æ•¸è¼ƒå°‘ã€‚</span>
        </div>

        <div class="form-group">
            <label>1. ä¸Šå‚³åœ–ç‰‡</label>
            <input type="file" id="dct-file" accept="image/*">
        </div>
        
        <div class="form-group">
            <label>2. æµ®æ°´å°å…§å®¹ (å»ºè­°ç°¡çŸ­ï¼Œå¦‚ç‰ˆæ¬Šå)</label>
            <input type="text" id="dct-msg" placeholder="ä¾‹å¦‚: Â©Henry2025" style="width:100%; padding:10px; box-sizing:border-box; border:1px solid #ddd; border-radius:6px;">
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn" style="background: #e67e22;" onclick="processDCT('encode')">ğŸ”¨ è£½ä½œæµ®æ°´å°</button>
            <button class="btn" style="background: #d35400;" onclick="processDCT('decode')">ğŸ” æå–æµ®æ°´å°</button>
        </div>
        
        <div id="dct-status" class="status-msg"></div>
        <div id="dct-result-box" class="result-box" style="display:none; margin-top:15px; border-left-color: #e67e22;">
            <strong>æå–çµæœï¼š</strong><br>
            <span id="dct-res-text"></span>
        </div>
    </div>
</div>

<script>
    // === 1. åˆå§‹åŒ–èˆ‡å…¨åŸŸè®Šæ•¸ ===
    const grid = document.getElementById('bitGrid');
    
    // ç”Ÿæˆä½å…ƒé¸æ“‡ç¶²æ ¼ (7 down to 0)
    for (let i = 7; i >= 0; i--) {
        let rowLabel = document.createElement('div');
        rowLabel.className = 'grid-row-label';
        rowLabel.innerText = i;
        grid.appendChild(rowLabel);
        
        for (let c = 0; c < 3; c++) {
            let wrapper = document.createElement('div');
            let chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.className = 'bit-check';
            chk.dataset.bit = i;
            chk.dataset.channel = c;
            if (i === 0) chk.checked = true; // é è¨­é¸ Bit 0
            wrapper.appendChild(chk);
            grid.appendChild(wrapper);
        }
    }

    // ç”Ÿæˆåµæ¸¬é¢æ¿çš„æŒ‰éˆ•
    for(let c=0; c<3; c++) {
        let group = document.getElementById(`btn-group-${c}`);
        for(let i=7; i>=0; i--) {
            let btn = document.createElement('button');
            btn.className = 'bit-btn';
            btn.innerText = i;
            btn.onclick = () => visualizeBit(c, i, btn);
            group.appendChild(btn);
        }
    }

    // === 2. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ===

    function resetToDefault() {
        document.querySelectorAll('.bit-check').forEach(chk => {
            chk.checked = (chk.dataset.bit === "0");
        });
    }

    function setMode(mode) {
        // 1. è™•ç† Tab æ¨£å¼
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        // 2. è™•ç†é¢æ¿åˆ‡æ›
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`${mode}-panel`).classList.add('active');

        // 3. âœ¨ å„ªåŒ–ï¼šåœ¨ DCT æˆ– Analyze æ¨¡å¼ä¸‹ï¼Œéš±è—ä¸Šæ–¹çš„ä½å…ƒåœ°åœ–
        const controlWrapper = document.querySelector('.controls-wrapper');
        
        // å¦‚æœæ˜¯ DCT (æµ®æ°´å°) æˆ– Analyze (åµæ¸¬)ï¼Œéƒ½æŠŠä¸Šé¢çš„å‹¾é¸æ¡†è—èµ·ä¾†
        if (mode === 'dct' || mode === 'analyze') {
            controlWrapper.style.display = 'none';
        } else {
            // åªæœ‰ Encode (åŠ å¯†) å’Œ Decode (è§£å¯†) éœ€è¦å®ƒ
            controlWrapper.style.display = 'block';
        }
    }

    function getBitMap() {
        const checkboxes = document.querySelectorAll('.bit-check:checked');
        let map = [];
        checkboxes.forEach(chk => {
            map.push({ c: parseInt(chk.dataset.channel), b: parseInt(chk.dataset.bit) });
        });
        return map;
    }

    async function process(action) {
        const fileInput = document.getElementById(action === 'encode' ? 'enc-file' : 'dec-file');
        const statusEl = document.getElementById(action === 'encode' ? 'enc-status' : 'dec-status');
        const resultArea = document.getElementById('result-area');
        
        statusEl.innerText = "";
        statusEl.style.color = "#333";
        
        if(!fileInput.files[0]) { alert("è«‹é¸æ“‡åœ–ç‰‡"); return; }
        
        const bitMap = getBitMap();
         if(bitMap.length === 0) { alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ä½å…ƒï¼"); return; }
        
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('bit_map', JSON.stringify(bitMap));
        
        if(action === 'encode') {
            const msg = document.getElementById('enc-msg').value;
            if(!msg) { alert("è«‹è¼¸å…¥è¨Šæ¯"); return; }
            formData.append('message', msg);
            statusEl.innerText = "è™•ç†ä¸­...";
        } else {
            statusEl.innerText = "è§£ç¢¼ä¸­...";
            resultArea.style.display = 'none';
        }

        try {
            const res = await fetch(`/${action}`, { method: 'POST', body: formData });
            
            // ğŸ”¥ ã€å„ªåŒ–é‡é»ã€‘æŠŠæª¢æŸ¥ç§»åˆ°æœ€ä¸Šé¢ï¼ŒåŒæ™‚ä¿è­·åŠ å¯†èˆ‡è§£å¯†
            if(!res.ok) {
                const errText = await res.text();
                // å¦‚æœæ–‡å­—æ˜¯ç©ºçš„ï¼Œå°±é¡¯ç¤ºç‹€æ…‹ç¢¼ (ä¾‹å¦‚ 502 Bad Gateway)
                throw new Error(errText || `ä¼ºæœå™¨é€£ç·šéŒ¯èª¤ (ä»£ç¢¼: ${res.status})`);
            }

            if(action === 'encode') {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'stego_result.png';
                document.body.appendChild(a); a.click(); a.remove();
                statusEl.innerText = "âœ… åŠ å¯†æˆåŠŸï¼åœ–ç‰‡å·²ä¸‹è¼‰ã€‚";
                statusEl.style.color = "green";
            } else {
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                
                if(data.message.includes("è§£å¯†å¤±æ•—")) {
                    statusEl.innerText = data.message;
                    statusEl.style.color = "red";
                } else {
                    document.getElementById('dec-result-text').innerText = data.message;
                    document.getElementById('res-title').innerText = "è§£æçµæœ (æ‰‹å‹•æ¨¡å¼)ï¼š";
                    resultArea.style.display = 'block';
                    statusEl.innerText = "âœ… è§£ç¢¼æˆåŠŸ";
                    statusEl.style.color = "green";
                }
            }
        } catch(e) {
            console.error("è©³ç´°éŒ¯èª¤å…§å®¹:", e);
            statusEl.innerText = "éŒ¯èª¤: " + (e.message || "æœªçŸ¥éŒ¯èª¤");
            statusEl.style.color = "red";
        }
    }

    async function processDCT(action) {
        const fileInput = document.getElementById('dct-file');
        const msgInput = document.getElementById('dct-msg');
        const statusEl = document.getElementById('dct-status');
        const resBox = document.getElementById('dct-result-box');
        
        statusEl.innerText = (action === 'dct_encode' ? "è£½ä½œä¸­..." : "åˆ†æä¸­...");
        statusEl.style.color = "#333";
        resBox.style.display = 'none';

        if(!fileInput.files[0]) { alert("è«‹é¸æ“‡åœ–ç‰‡"); return; }
        if(action === 'encode' && !msgInput.value) { alert("è«‹è¼¸å…¥æµ®æ°´å°æ–‡å­—"); return; }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        if(action === 'encode') formData.append('message', msgInput.value);

        // å°æ‡‰å¾Œç«¯è·¯ç”±åç¨±
        const route = action === 'encode' ? '/dct_encode' : '/dct_decode';

        try {
            const res = await fetch(route, { method: 'POST', body: formData });
            
            if(!res.ok) {
                const errText = await res.text();
                throw new Error(errText || `ä¼ºæœå™¨éŒ¯èª¤ (${res.status})`);
            }

            if(action === 'encode') {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'dct_watermark.png';
                document.body.appendChild(a); a.click(); a.remove();
                statusEl.innerText = "âœ… æµ®æ°´å°è£½ä½œæˆåŠŸï¼";
                statusEl.style.color = "green";
            } else {
                const data = await res.json();
                document.getElementById('dct-res-text').innerText = data.message;
                resBox.style.display = 'block';
                statusEl.innerText = "âœ… åˆ†æå®Œæˆ";
                statusEl.style.color = "green";
            }
        } catch(e) {
            console.error(e);
            statusEl.innerText = "éŒ¯èª¤: " + e.message;
            statusEl.style.color = "red";
        }
    }

    async function autoDecode() {
        const fileInput = document.getElementById('dec-file');
        const statusEl = document.getElementById('dec-status');
        const resultArea = document.getElementById('result-area');
        
        if(!fileInput.files[0]) { alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡"); return; }
        
        statusEl.innerText = "ğŸ•µï¸â€â™‚ï¸ æ­£åœ¨æš´åŠ›ç ´è§£æ‰€æœ‰å¸¸è¦‹çµ„åˆ...";
        statusEl.style.color = "var(--warn)";
        resultArea.style.display = 'none';
        
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        
        try {
            const res = await fetch('/auto_decode', { method: 'POST', body: formData });
            const data = await res.json();
            
            if(data.success) {
                document.getElementById('res-title').innerHTML = `ğŸ‰ ç ´è§£æˆåŠŸï¼(ç­–ç•¥: ${data.strategy})`;
                document.getElementById('dec-result-text').innerText = data.message;
                resultArea.style.display = 'block';
                statusEl.innerText = "âœ… è¨Šæ¯å·²é‚„åŸ";
                statusEl.style.color = "green";
                
                // è‡ªå‹•æ›´æ–° UI å‹¾é¸æ¡†
                resetToDefault();
                document.querySelectorAll('.bit-check').forEach(chk => chk.checked = false); // å…¨æ¸…
                data.found_map.forEach(m => {
                    const chk = document.querySelector(`.bit-check[data-channel="${m.c}"][data-bit="${m.b}"]`);
                    if(chk) chk.checked = true;
                });
            } else {
                statusEl.innerText = "âŒ " + data.message;
                statusEl.style.color = "red";
            }
        } catch(e) {
            statusEl.innerText = "éŒ¯èª¤: " + e.message;
        }
    }

    // === 3. è¦–è¦ºåŒ–åµæ¸¬é‚è¼¯ ===
    let anaImg = new Image();
    let originalImageData = null;
    const canvas = document.getElementById('ana-canvas');
    const ctx = canvas.getContext('2d');

    document.getElementById('ana-file').addEventListener('change', function(e) {
        if(e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                anaImg.src = evt.target.result;
                anaImg.onload = () => {
                    canvas.width = anaImg.width;
                    canvas.height = anaImg.height;
                    ctx.drawImage(anaImg, 0, 0);
                    originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    document.getElementById('ana-hint').innerText = "åœ–ç‰‡å·²è¼‰å…¥ï¼Œè«‹é¸æ“‡é€šé“æŸ¥çœ‹ã€‚";
                };
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function visualizeBit(ch, bit, btn) {
        if(!originalImageData) { alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡"); return; }
        
        document.querySelectorAll('.bit-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const imageData = new ImageData(new Uint8ClampedArray(originalImageData.data), canvas.width, canvas.height);
        const data = imageData.data;
        
        for(let i=0; i<data.length; i+=4) {
            const val = data[i+ch];
            const bitVal = (val >> bit) & 1;
            const color = bitVal * 255;
            data[i] = color; data[i+1] = color; data[i+2] = color;
        }
        ctx.putImageData(imageData, 0, 0);
        document.getElementById('ana-hint').innerText = `æ­£åœ¨æª¢è¦– Channel ${['R','G','B'][ch]} - Bit ${bit}`;
    }
</script>

</body>
</html>