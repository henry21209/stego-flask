<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://fav.farm/ğŸ”’" />
    <title>çµ‚æ¥µéš±å¯«è¡“å·¥å…·ç®±</title>
    <style>
        :root { --primary: #4a90e2; --success: #2ecc71; --danger: #e74c3c; --warn: #f39c12; --bg: #f4f7f6; }
        
        /* === åŸºç¤è¨­å®š === */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            display: flex; 
            justify-content: center; 
            padding: 15px; 
            min-height: 100vh; 
            box-sizing: border-box; 
            margin: 0;
        }

        .container { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 700px; 
            box-sizing: border-box;
        }

        /* ğŸ›¡ï¸ éš±ç§æ¬Šå®£å‘Š Footer */
        .footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 0.8rem;
            color: #999;
            line-height: 1.6;
        }

        h1 { 
            text-align: center; 
            color: #333; 
            margin: 10px 0 20px 0; 
            font-size: 1.5rem; 
        }
        
        /* === Tabs åˆ†é é¸å–® === */
        .tabs { 
            display: flex; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #eee; 
            flex-wrap: wrap; 
        }
        .tab { 
            flex: 1; 
            padding: 12px 5px; 
            cursor: pointer; 
            text-align: center; 
            font-weight: bold; 
            color: #aaa; 
            transition: 0.3s; 
            border-bottom: 3px solid transparent; 
            font-size: 0.95rem;
            white-space: nowrap; 
        }
        .tab:hover { background: #f9f9f9; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab.analyze-tab.active { color: var(--warn); border-bottom: 3px solid var(--warn); }

        /* === ä½å…ƒé¸æ“‡å€ === */
        .controls-wrapper { 
            background: #fafafa; 
            border: 1px solid #eee; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            animation: fadeIn 0.3s;
        }
        .control-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            flex-wrap: wrap; 
            gap: 10px;
        }
        
        .reset-btn { 
            background: #e0e0e0; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            transition: 0.2s; 
        }
        .reset-btn:hover { background: #d0d0d0; }
        
        /* Grid ç³»çµ± */
        .bit-grid { display: grid; grid-template-columns: 40px repeat(3, 1fr); gap: 6px; text-align: center; }
        .grid-header { font-weight: bold; padding: 6px; border-radius: 4px; font-size: 0.9rem; }
        .grid-row-label { font-weight: bold; line-height: 28px; color: #777; font-size: 0.9rem; }
        
        .bit-check { 
            width: 24px; 
            height: 24px; 
            cursor: pointer; 
            accent-color: var(--primary); 
            vertical-align: middle;
        }

        /* === Panels === */
        .panel { display: none; animation: fadeIn 0.3s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* === è¡¨å–®å…ƒç´  === */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        
        /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
        input[type="file"], textarea, input[type="text"] { 
            width: 100%; 
            padding: 12px; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 16px; 
        }
        textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        
        /* === æŒ‰éˆ•å„ªåŒ– === */
        .btn { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 1rem; 
            font-weight: bold; 
            color: white; 
            transition: 0.2s; 
            margin-top: 10px; 
            user-select: none; 
            -webkit-user-select: none; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background-color: #ccc !important; cursor: not-allowed; opacity: 0.8; transform: none; }
        
        .btn-blue { background: var(--primary); } .btn-blue:hover { background: #357abd; }
        .btn-green { background: var(--success); } .btn-green:hover { background: #27ae60; }
        .btn-purple { background: #9b59b6; } .btn-purple:hover { background: #8e44ad; }
        
        .status-msg { margin-top: 15px; text-align: center; font-size: 1rem; font-weight: 500; min-height: 20px; line-height: 1.5; }
        
        /* === çµæœå€åŸŸ === */
        #result-area { margin-top: 15px; display: none; }
        .result-box { background: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); word-break: break-all; white-space: pre-wrap; font-size: 0.95rem; }
        
        /* === åµæ¸¬ Canvas éŸ¿æ‡‰å¼ (æ”¯æ´é›™åœ–) === */
        .canvas-container { 
            margin: 15px 0; 
            border: 2px dashed #ccc; 
            background: #222; 
            min-height: 200px; 
            padding: 10px; 
            border-radius: 8px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 15px; 
        }
        
        .canvas-box {
            text-align: center;
            width: 48%; /* é›»è…¦ç‰ˆä¸¦æ’ */
            min-width: 300px;
        }
        
        canvas { 
            max-width: 100%; 
            height: auto; 
            border: 1px solid #555; 
            display: block; 
            margin: 0 auto; 
        }
        
        .canvas-label { color: #ccc; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
        
        /* === åµæ¸¬æŒ‰éˆ•ç¾¤çµ„ === */
        .bit-buttons-grid { 
            display: grid; 
            grid-template-columns: 30px 1fr; 
            gap: 10px; 
            margin-top: 15px; 
            align-items: center; 
        }
        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; }
        .bit-btn { 
            flex: 1; 
            padding: 8px 0; 
            font-size: 0.9rem; 
            cursor: pointer; 
            background: #fff; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            min-width: 35px; 
        }
        .bit-btn:hover { background: #eee; }
        .bit-btn.active { background: #333; color: white; border-color: black; }

        /* === ğŸŒ€ è¼‰å…¥å‹•ç•« (Spinner) === */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === ğŸ“± æ‰‹æ©Ÿç‰ˆ RWD èª¿æ•´ (Plan A: å¼·åˆ¶ä¸€æ’) === */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.4rem; }
            
            .tab { font-size: 0.85rem; padding: 10px 2px; }
            
            /* è®“ç•«å¸ƒè®Šç›´æ’ */
            .canvas-box { width: 100%; min-width: 100%; }
            
            /* æŒ‰éˆ•å¼·åˆ¶ä¸€æ’ (Plan A) */
            .btn-group { flex-wrap: nowrap; gap: 2px; }
            .bit-btn { padding: 8px 0; font-size: 0.75rem; min-width: 0; flex: 1; }
            
            /* èª¿æ•´æ¨™ç±¤ */
            .bit-buttons-grid { grid-template-columns: 20px 1fr; gap: 5px; }
            .bit-buttons-grid > div:nth-child(odd) { font-size: 0.9rem; }
            
            label { margin-top: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ•µï¸â€â™‚ï¸ çµ‚æ¥µéš±å¯«è¡“å·¥å…·ç®±</h1>

    <div class="tabs">
        <div class="tab active" onclick="setMode('encode')">åŠ å¯† (Encode)</div>
        <div class="tab" onclick="setMode('decode')">è§£å¯† (Decode)</div>
        <div class="tab analyze-tab" onclick="setMode('analyze')">ğŸ‘ï¸ åµæ¸¬ (Analyze)</div>
        <div class="tab" style="color: #e67e22;" onclick="setMode('dct')">ğŸŒŠ æµ®æ°´å° (DCT)</div>
    </div>
    
    <div class="controls-wrapper">
        <div class="control-header">
            <strong>ğŸ”‘ ä½å…ƒåœ°åœ– (Bit Map) - åŠ è§£å¯†çš„é‘°åŒ™</strong>
            <button class="reset-btn" onclick="resetToDefault()">â†º é‡è¨­ç‚ºé è¨­ (LSB)</button>
        </div>
        <div class="bit-grid" id="bitGrid">
            <div></div>
            <div class="grid-header" style="background:#ffebee; color:#c62828">R</div>
            <div class="grid-header" style="background:#e8f5e9; color:#2e7d32">G</div>
            <div class="grid-header" style="background:#e3f2fd; color:#1565c0">B</div>
        </div>
        <p style="font-size: 0.8rem; color: #888; text-align: center; margin-top: 8px;">
            æç¤ºï¼šBit 0 å°ç•«è³ªå½±éŸ¿æœ€å°ï¼ŒBit 7 å½±éŸ¿æœ€å¤§ã€‚è§£å¯†æ™‚å¿…é ˆèˆ‡åŠ å¯†è¨­å®šå®Œå…¨ä¸€è‡´ã€‚
        </p>
    </div>

    <div id="encode-panel" class="panel active">
        <div class="form-group">
            <label>1. ä¸Šå‚³åŸå§‹åœ–ç‰‡</label>
            <input type="file" id="enc-file" accept="image/*">
        </div>
        <div class="form-group">
            <label>2. è¼¸å…¥ç§˜å¯†è¨Šæ¯</label>
            <textarea id="enc-msg" placeholder="åœ¨æ­¤è¼¸å…¥æ–‡å­—..."></textarea>
        </div>
        <button class="btn btn-blue" onclick="process('encode')">ğŸ”’ å¯«å…¥éš±è—è¨Šæ¯ä¸¦ä¸‹è¼‰</button>
        <div id="enc-status" class="status-msg"></div>
    </div>

    <div id="decode-panel" class="panel">
        <div class="form-group">
            <label>ä¸Šå‚³å«æœ‰ç§˜å¯†çš„åœ–ç‰‡</label>
            <input type="file" id="dec-file" accept="image/*">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-green" onclick="process('decode')">ğŸ”“ ä¾è¨­å®šè§£å¯†</button>
            <button class="btn btn-purple" onclick="autoDecode()">ğŸª„ è‡ªå‹•æš´åŠ›ç ´è§£</button>
        </div>
        
        <div id="result-area">
            <div class="result-box">
                <strong id="res-title">è§£æçµæœï¼š</strong>
                <div id="dec-result-text" style="margin-top:5px;"></div>
            </div>
        </div>
        <div id="dec-status" class="status-msg"></div>
    </div>

    <div id="analyze-panel" class="panel">
        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #90caf9;">
            <strong>ğŸ‘ï¸ æ¯”è¼ƒæ¨¡å¼ï¼š</strong><br>
            <span style="color: #1565c0; font-size: 0.9em;">
                ä½ å¯ä»¥åªä¸Šå‚³å·¦é‚Š (å–®å¼µæª¢è¦–)ï¼Œä¹Ÿå¯ä»¥åŒæ™‚ä¸Šå‚³å³é‚Š (é€²è¡Œå°ç…§)ã€‚
            </span>
        </div>

        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1;">
                <label>1. ä¸Šå‚³åŸåœ– (åœ–ç‰‡ A)</label>
                <input type="file" id="ana-file-1" accept="image/*">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>2. ä¸Šå‚³åŠ å¯†åœ– (åœ–ç‰‡ B)</label>
                <input type="file" id="ana-file-2" accept="image/*">
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-box" id="box-1" style="display:none;">
                <div class="canvas-label">åœ–ç‰‡ A (Original)</div>
                <canvas id="ana-canvas-1"></canvas>
            </div>
            
            <div class="canvas-box" id="box-2" style="display:none;">
                <div class="canvas-label">åœ–ç‰‡ B (Modified)</div>
                <canvas id="ana-canvas-2"></canvas>
            </div>
            
            <div id="empty-msg" style="color: #666; align-self: center;">è«‹ä¸Šå‚³è‡³å°‘ä¸€å¼µåœ–ç‰‡</div>
        </div>
        
        <p style="text-align: center; color: #666; font-size: 0.9rem;" id="ana-hint">åœ–ç‰‡è¼‰å…¥å¾Œï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•åˆ‡æ›ä½å…ƒå±¤</p>
        
        <div class="bit-buttons-grid">
            <div style="color:#e74c3c; font-weight:bold; line-height:30px;">R</div>
            <div id="btn-group-0" class="btn-group"></div>
            <div style="color:#2ecc71; font-weight:bold; line-height:30px;">G</div>
            <div id="btn-group-1" class="btn-group"></div>
            <div style="color:#3498db; font-weight:bold; line-height:30px;">B</div>
            <div id="btn-group-2" class="btn-group"></div>
        </div>
    </div>

    <div id="dct-panel" class="panel">
        <div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffcc80;">
            <strong>ğŸŒŠ ä»€éº¼æ˜¯ DCT æµ®æ°´å°ï¼Ÿ</strong><br>
            ä¸åŒæ–¼ä¸Šé¢çš„ LSB åŠ å¯†ï¼ŒDCT æŠ€è¡“æ˜¯å°‡æ–‡å­—åˆ»åœ¨åœ–ç‰‡çš„ã€Œé »ç‡ã€ä¸­ã€‚<br>
            <span style="color: #d35400; font-size: 0.9em;">ç‰¹é»ï¼šæŠ—å£“ç¸® (å­˜æˆ JPG ä¹Ÿä¸æœƒæ¶ˆå¤±)ã€æŠ—è£åˆ‡ï¼Œä½†èƒ½è—çš„å­—æ•¸è¼ƒå°‘ã€‚</span>
        </div>

        <div class="form-group">
            <label>1. ä¸Šå‚³åœ–ç‰‡</label>
            <input type="file" id="dct-file" accept="image/*">
        </div>
        
        <div class="form-group">
            <label>2. æµ®æ°´å°å…§å®¹ (å»ºè­°ç°¡çŸ­)</label>
            <input type="text" id="dct-msg" placeholder="ä¾‹å¦‚: Â©Henry2025" style="width:100%;">
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn" style="background: #e67e22;" onclick="processDCT('encode')">ğŸ”¨ è£½ä½œæµ®æ°´å°</button>
            <button class="btn" style="background: #d35400;" onclick="processDCT('decode')">ğŸ” æå–æµ®æ°´å°</button>
        </div>
        
        <div id="dct-status" class="status-msg"></div>
        <div id="dct-result-box" class="result-box" style="display:none; margin-top:15px; border-left-color: #e67e22;">
            <strong>æå–çµæœï¼š</strong><br>
            <span id="dct-res-text"></span>
        </div>
    </div>

    <div id="progress-container" style="display: none; margin-top: 15px;">
        <div style="background: #eee; border-radius: 10px; height: 10px; overflow: hidden; width: 100%;">
            <div id="fake-progress-bar" style="background: var(--primary); width: 0%; height: 100%; transition: width 0.3s ease-out;"></div>
        </div>
        <div id="progress-text" style="text-align: center; font-size: 0.85rem; color: #666; margin-top: 5px;">0%</div>
    </div>

    <div class="footer">
        ğŸ”’ <strong>éš±ç§æ¬Šæ‰¿è«¾ï¼š</strong><br>
        æœ¬å·¥å…·æ¡ç”¨ã€Œç„¡ä¼ºæœå™¨æš«å­˜ã€æŠ€è¡“ï¼Œæ‰€æœ‰åœ–ç‰‡åƒ…åœ¨è¨˜æ†¶é«”ä¸­é‹ç®—ï¼Œ<br>
        è™•ç†å®Œç•¢å¾Œå³åˆ»é‡‹æ”¾ï¼Œçµ•ä¸ç•™å­˜ä»»ä½•æª”æ¡ˆæ–¼ä¼ºæœå™¨ï¼Œè«‹å®‰å¿ƒä½¿ç”¨ã€‚
    </div>

</div>

<script>
    // === 1. åˆå§‹åŒ–ä»‹é¢ ===
    const grid = document.getElementById('bitGrid');
    
    // ç”Ÿæˆä½å…ƒé¸æ“‡ç¶²æ ¼
    for (let i = 7; i >= 0; i--) {
        let rowLabel = document.createElement('div');
        rowLabel.className = 'grid-row-label';
        rowLabel.innerText = i;
        grid.appendChild(rowLabel);
        
        for (let c = 0; c < 3; c++) {
            let wrapper = document.createElement('div');
            let chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.className = 'bit-check';
            chk.dataset.bit = i;
            chk.dataset.channel = c;
            if (i === 0) chk.checked = true; 
            wrapper.appendChild(chk);
            grid.appendChild(wrapper);
        }
    }

    // ç”Ÿæˆåµæ¸¬é¢æ¿æŒ‰éˆ•
    for(let c=0; c<3; c++) {
        let group = document.getElementById(`btn-group-${c}`);
        for(let i=7; i>=0; i--) {
            let btn = document.createElement('button');
            btn.className = 'bit-btn';
            btn.innerText = i;
            btn.onclick = () => visualizeBit(c, i, btn);
            group.appendChild(btn);
        }
    }

    // === ğŸ–¼ï¸ å‰ç«¯åœ–ç‰‡å£“ç¸®å¼•æ“ ===
    function compressImage(file, maxWidth = 1200) {
        return new Promise((resolve, reject) => {
            // 1. å¦‚æœä¸æ˜¯åœ–ç‰‡ï¼Œç›´æ¥å›å‚³åŸæª”
            if (!file.type.match(/image.*/)) return resolve(file);

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    // 2. è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxWidth) {
                        if (width > height) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        } else {
                            width = Math.round(width * (maxWidth / height));
                            height = maxWidth;
                        }
                    } else {
                        // å¦‚æœåœ–ç‰‡æœ¬ä¾†å°±å¾ˆå°ï¼Œä¸éœ€è¦å£“ç¸®ï¼Œå›å‚³åŸæª”
                        return resolve(file);
                    }

                    // 3. ç”¨ Canvas é‡ç¹ª (ç¸®åœ–)
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // 4. è½‰å› Blob (PNG æ ¼å¼ä»¥ç¢ºä¿ LSB è³‡æ–™ä¸å¤±çœŸï¼Œä½†é€™è£¡æˆ‘å€‘åªæ˜¯ç¸®åœ–ç•¶ç´ æ)
                    // ç‚ºäº†éš±å¯«è¡“çš„ç©©å®šæ€§ï¼Œæˆ‘å€‘çµ±ä¸€è½‰æˆ PNG
                    canvas.toBlob((blob) => {
                        // å»ºç«‹ä¸€å€‹æ–°çš„ File ç‰©ä»¶é¨™éå¾Œç«¯
                        const newFile = new File([blob], file.name.replace(/\.\w+$/, ".png"), {
                            type: 'image/png',
                            lastModified: Date.now()
                        });
                        console.log(`å£“ç¸®å®Œæˆ: ${file.size} -> ${newFile.size} bytes`);
                        resolve(newFile);
                    }, 'image/png', 1.0);
                };
                img.onerror = (err) => reject(err);
            };
        });
    }

    // === 2. UI åˆ‡æ›é‚è¼¯ ===
    function setMode(mode) {
        // Tabs æ¨£å¼
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        // Panels åˆ‡æ›
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`${mode}-panel`).classList.add('active');

        // éš±è—/é¡¯ç¤ºä½å…ƒåœ°åœ–
        const controlWrapper = document.querySelector('.controls-wrapper');
        if (mode === 'dct' || mode === 'analyze') {
            controlWrapper.style.display = 'none';
        } else {
            controlWrapper.style.display = 'block';
        }
    }

    function resetToDefault() {
        document.querySelectorAll('.bit-check').forEach(chk => {
            chk.checked = (chk.dataset.bit === "0");
        });
    }

    function getBitMap() {
        const checkboxes = document.querySelectorAll('.bit-check:checked');
        let map = [];
        checkboxes.forEach(chk => {
            map.push({ c: parseInt(chk.dataset.channel), b: parseInt(chk.dataset.bit) });
        });
        return map;
    }

    // === 3. ğŸ­ å‡é€²åº¦æ¢æ§åˆ¶å™¨ ===
    let progressInterval = null;
    const totalDuration = 10000; // ç›®æ¨™ 10 ç§’

    function startFakeProgress() {
        const container = document.getElementById('progress-container');
        const bar = document.getElementById('fake-progress-bar');
        const text = document.getElementById('progress-text');
        
        container.style.display = 'block';
        bar.style.width = '0%';
        text.innerText = '0%';
        
        let currentProgress = 0;
        const startTime = Date.now();
        
        if (progressInterval) clearInterval(progressInterval);

        progressInterval = setInterval(() => {
            const elapsedTime = Date.now() - startTime;
            const idealProgress = (elapsedTime / totalDuration) * 99;
            const randomStep = Math.random() * 2; 
            
            if (currentProgress < idealProgress) {
                currentProgress += randomStep;
            } else {
                currentProgress += 0.05;
            }

            if (currentProgress >= 99) currentProgress = 99;

            bar.style.width = `${currentProgress}%`;
            text.innerText = `${Math.floor(currentProgress)}%`;
        }, 100);
    }

    function finishFakeProgress() {
        const bar = document.getElementById('fake-progress-bar');
        const text = document.getElementById('progress-text');
        
        if (progressInterval) clearInterval(progressInterval);
        
        bar.style.width = '100%';
        text.innerText = '100% å®Œæˆï¼';
        
        setTimeout(() => {
            document.getElementById('progress-container').style.display = 'none';
        }, 1500);
    }

    // === 4. LSB è™•ç†é‚è¼¯ ===
    async function process(action) {
        const fileInput = document.getElementById(action === 'encode' ? 'enc-file' : 'dec-file');
        const statusEl = document.getElementById(action === 'encode' ? 'enc-status' : 'dec-status');
        const resultArea = document.getElementById('result-area');
        
        statusEl.innerText = "";
        
        if(!fileInput.files[0]) { alert("è«‹é¸æ“‡åœ–ç‰‡"); return; }

        let fileToUpload = fileInput.files[0];
        
        // åªæœ‰ã€ŒåŠ å¯†ã€æ™‚æ‰éœ€è¦å£“ç¸® (è§£å¯†å¿…é ˆç¶­æŒåŸæ¨£)
        if (action === 'encode') {
            statusEl.innerText = "æ­£åœ¨å£“ç¸®åœ–ç‰‡..."; // è®“ä½¿ç”¨è€…çŸ¥é“åœ¨å¿™ä»€éº¼
            try {
                // å¼·åˆ¶ç¸®åˆ° 1200px å¯¬åº¦ï¼Œä¿è­‰ç§’å‚³
                fileToUpload = await compressImage(fileToUpload, 1200);
            } catch (err) {
                console.error("å£“ç¸®å¤±æ•—ï¼Œå°‡ä½¿ç”¨åŸåœ–", err);
            }
        }
        
        const bitMap = getBitMap();
         if(bitMap.length === 0) { alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ä½å…ƒï¼"); return; }
        
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('bit_map', JSON.stringify(bitMap));
        
        if(action === 'encode') {
            const msg = document.getElementById('enc-msg').value;
            if(!msg) { alert("è«‹è¼¸å…¥è¨Šæ¯"); return; }
            formData.append('message', msg);
            statusEl.innerHTML = '<div class="spinner"></div> æ­£åœ¨å¯«å…¥éš±è—è¨Šæ¯...';
        } else {
            statusEl.innerHTML = '<div class="spinner"></div> æ­£åœ¨è§£ç¢¼åˆ†æä¸­...';
            resultArea.style.display = 'none';
        }

        startFakeProgress(); // å•Ÿå‹•é€²åº¦æ¢
        document.querySelectorAll('.btn').forEach(b => b.disabled = true);

        try {
            const res = await fetch(`/${action}`, { method: 'POST', body: formData });
            
            if(!res.ok) {
                const errText = await res.text();
                throw new Error(errText || `ä¼ºæœå™¨é€£ç·šéŒ¯èª¤ (ä»£ç¢¼: ${res.status})`);
            }

            finishFakeProgress(); // å®Œæˆé€²åº¦æ¢

            if(action === 'encode') {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'stego_result.png';
                document.body.appendChild(a); a.click(); a.remove();
                statusEl.innerText = "âœ… åŠ å¯†æˆåŠŸï¼åœ–ç‰‡å·²ä¸‹è¼‰ã€‚";
                statusEl.style.color = "green";
            } else {
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                
                if(data.message.includes("è§£å¯†å¤±æ•—")) {
                    statusEl.innerText = data.message;
                    statusEl.style.color = "red";
                } else {
                    document.getElementById('dec-result-text').innerText = data.message;
                    document.getElementById('res-title').innerText = "è§£æçµæœ (æ‰‹å‹•æ¨¡å¼)ï¼š";
                    resultArea.style.display = 'block';
                    statusEl.innerText = "âœ… è§£ç¢¼æˆåŠŸ";
                    statusEl.style.color = "green";
                }
            }
        } catch(e) {
            console.error(e);
            if (progressInterval) clearInterval(progressInterval);
            document.getElementById('progress-container').style.display = 'none';
            statusEl.innerText = "éŒ¯èª¤: " + (e.message || "æœªçŸ¥éŒ¯èª¤");
            statusEl.style.color = "red";
        } finally {
            document.querySelectorAll('.btn').forEach(b => b.disabled = false);
        }
    }

    async function autoDecode() {
        const fileInput = document.getElementById('dec-file');
        const statusEl = document.getElementById('dec-status');
        const resultArea = document.getElementById('result-area');
        
        if(!fileInput.files[0]) { alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡"); return; }
        
        statusEl.innerHTML = '<div class="spinner" style="border-top-color: var(--warn);"></div> æ­£åœ¨æš´åŠ›ç ´è§£...';
        statusEl.style.color = "var(--warn)";
        resultArea.style.display = 'none';
        
        startFakeProgress();
        document.querySelectorAll('.btn').forEach(b => b.disabled = true);
        
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        
        try {
            const res = await fetch('/auto_decode', { method: 'POST', body: formData });
            const data = await res.json();
            
            finishFakeProgress();

            if(data.success) {
                document.getElementById('res-title').innerHTML = `ğŸ‰ ç ´è§£æˆåŠŸï¼(ç­–ç•¥: ${data.strategy})`;
                document.getElementById('dec-result-text').innerText = data.message;
                resultArea.style.display = 'block';
                statusEl.innerText = "âœ… è¨Šæ¯å·²é‚„åŸ";
                statusEl.style.color = "green";
                
                resetToDefault();
                document.querySelectorAll('.bit-check').forEach(chk => chk.checked = false);
                data.found_map.forEach(m => {
                    const chk = document.querySelector(`.bit-check[data-channel="${m.c}"][data-bit="${m.b}"]`);
                    if(chk) chk.checked = true;
                });
            } else {
                statusEl.innerText = "âŒ " + data.message;
                statusEl.style.color = "red";
            }
        } catch(e) {
            if (progressInterval) clearInterval(progressInterval);
            statusEl.innerText = "éŒ¯èª¤: " + e.message;
            statusEl.style.color = "red";
        } finally {
            document.querySelectorAll('.btn').forEach(b => b.disabled = false);
        }
    }

    async function processDCT(action) {
        const fileInput = document.getElementById('dct-file');
        const msgInput = document.getElementById('dct-msg');
        const statusEl = document.getElementById('dct-status');
        const resBox = document.getElementById('dct-result-box');
        
        statusEl.innerHTML = '<div class="spinner" style="border-top-color: #e67e22;"></div> ' + (action === 'dct_encode' ? "æ­£åœ¨è£½ä½œæµ®æ°´å°..." : "æ­£åœ¨æå–æµ®æ°´å°...");
        statusEl.style.color = "#333";
        resBox.style.display = 'none';

        if(!fileInput.files[0]) { alert("è«‹é¸æ“‡åœ–ç‰‡"); return; }
        if(action === 'encode' && !msgInput.value) { alert("è«‹è¼¸å…¥æµ®æ°´å°æ–‡å­—"); return; }

        let fileToUpload = fileInput.files[0];
        
        // åªæœ‰ã€ŒåŠ å¯†ã€æ™‚æ‰éœ€è¦å£“ç¸® (è§£å¯†å¿…é ˆç¶­æŒåŸæ¨£)
        if (action === 'encode') {
            statusEl.innerText = "æ­£åœ¨å£“ç¸®åœ–ç‰‡..."; // è®“ä½¿ç”¨è€…çŸ¥é“åœ¨å¿™ä»€éº¼
            try {
                // å¼·åˆ¶ç¸®åˆ° 1200px å¯¬åº¦ï¼Œä¿è­‰ç§’å‚³
                fileToUpload = await compressImage(fileToUpload, 1200);
            } catch (err) {
                console.error("å£“ç¸®å¤±æ•—ï¼Œå°‡ä½¿ç”¨åŸåœ–", err);
            }
        }

        startFakeProgress();
        document.querySelectorAll('.btn').forEach(b => b.disabled = true);

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        if(action === 'encode') formData.append('message', msgInput.value);

        const route = action === 'encode' ? '/dct_encode' : '/dct_decode';

        try {
            const res = await fetch(route, { method: 'POST', body: formData });
            
            if(!res.ok) {
                const errText = await res.text();
                throw new Error(errText || `ä¼ºæœå™¨éŒ¯èª¤ (${res.status})`);
            }
            
            finishFakeProgress();

            if(action === 'encode') {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'dct_watermark.png';
                document.body.appendChild(a); a.click(); a.remove();
                statusEl.innerText = "âœ… æµ®æ°´å°è£½ä½œæˆåŠŸï¼";
                statusEl.style.color = "green";
            } else {
                const data = await res.json();
                document.getElementById('dct-res-text').innerText = data.message;
                resBox.style.display = 'block';
                statusEl.innerText = "âœ… åˆ†æå®Œæˆ";
                statusEl.style.color = "green";
            }
        } catch(e) {
            console.error(e);
            if (progressInterval) clearInterval(progressInterval);
            statusEl.innerText = "éŒ¯èª¤: " + e.message;
            statusEl.style.color = "red";
        } finally {
            document.querySelectorAll('.btn').forEach(b => b.disabled = false);
        }
    }

    // === 5. åµæ¸¬é‚è¼¯ (é›™åœ–) ===
    const imgDataStore = {
        1: { original: null, width: 0, height: 0 },
        2: { original: null, width: 0, height: 0 }
    };

    setupAnalyzeUpload('ana-file-1', 1);
    setupAnalyzeUpload('ana-file-2', 2);

    function setupAnalyzeUpload(inputId, slotId) {
        document.getElementById(inputId).addEventListener('change', function(e) {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.src = evt.target.result;
                    img.onload = () => {
                        document.getElementById(`box-${slotId}`).style.display = 'block';
                        document.getElementById('empty-msg').style.display = 'none';

                        const canvas = document.getElementById(`ana-canvas-${slotId}`);
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        imgDataStore[slotId].original = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        imgDataStore[slotId].width = img.width;
                        imgDataStore[slotId].height = img.height;
                        
                        const activeBtn = document.querySelector('.bit-btn.active');
                        if (activeBtn) {
                            activeBtn.click();
                        } else {
                            document.getElementById('ana-hint').innerText = "åœ–ç‰‡å·²è¼‰å…¥ï¼Œè«‹é¸æ“‡é€šé“æŸ¥çœ‹ã€‚";
                        }
                    };
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
    }

    function visualizeBit(ch, bit, btn) {
        if(!imgDataStore[1].original && !imgDataStore[2].original) { 
            alert("è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µåœ–ç‰‡"); 
            return; 
        }
        
        document.querySelectorAll('.bit-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.getElementById('ana-hint').innerText = `æ­£åœ¨æª¢è¦– Channel ${['R','G','B'][ch]} - Bit ${bit}`;

        const renderCanvas = (slotId) => {
            const source = imgDataStore[slotId];
            if (!source.original) return;

            const canvas = document.getElementById(`ana-canvas-${slotId}`);
            const ctx = canvas.getContext('2d');
            
            const imageData = new ImageData(
                new Uint8ClampedArray(source.original.data), 
                source.width, 
                source.height
            );
            const data = imageData.data;
            
            for(let i=0; i<data.length; i+=4) {
                const val = data[i+ch];
                const bitVal = (val >> bit) & 1;
                const color = bitVal * 255;
                data[i] = color; data[i+1] = color; data[i+2] = color;
            }
            ctx.putImageData(imageData, 0, 0);
        };

        renderCanvas(1);
        renderCanvas(2);
    }
</script>

</body>
</html>